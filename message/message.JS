let selectedFile = null;

// ìš”ì†Œ ì„ íƒ
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const chatMessages = document.getElementById('chat-messages');
const promptAside = document.getElementById('prompt-aside');
const promptEditor = document.getElementById('prompt-editor-box');
const filePreviewContainer = document.getElementById('file-preview-container');

// 1. í†µí•© ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
function sendMessage() {
    if (!chatInput) return;
    const text = chatInput.value.trim();
    if (!text && !selectedFile) return;

    // ìˆ˜ì •: selectedFile ê°ì²´ ìì²´ë¥¼ í¬í•¨í•˜ì—¬ ì „ë‹¬ (ë‹¤ìš´ë¡œë“œ URL ìƒì„±ì„ ìœ„í•¨)
    const messageData = {
        text: text,
        file: selectedFile ? { 
            name: selectedFile.name, 
            blob: selectedFile // íŒŒì¼ ë°ì´í„° ì›ë³¸ ì¶”ê°€
        } : null
    };

    renderCombinedMessage(messageData);

    chatInput.value = "";
    removeFilePreview();
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// 2. í†µí•© ë©”ì‹œì§€ ë Œë”ë§
function renderCombinedMessage(data) {
    const msgId = Date.now();
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message right';

    // íŒŒì¼ ë ˆì´ì•„ì›ƒ (ë‹¤ìš´ë¡œë“œ ë§í¬ ì¶”ê°€)
    let fileHtml = "";
    if (data.file) {
        // ì¶”ê°€: ë¸Œë¼ìš°ì € ë©”ëª¨ë¦¬ì— ì„ì‹œ ë‹¤ìš´ë¡œë“œ ê²½ë¡œ ìƒì„±
        const downloadUrl = URL.createObjectURL(data.file.blob);
        
        fileHtml = `
            <div class="file-attachment" style="display: flex; align-items: center; justify-content: space-between; background: #f8fafc; padding: 10px; border-radius: 10px; margin-bottom: 8px; border: 1px solid #f1f5f9; color: #475569; font-size: 14px; min-width: 200px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="material-icons" style="color: #3b82f6; font-size: 18px;">description</span>
                    <span class="file-name">${data.file.name}</span>
                </div>
                <a href="${downloadUrl}" download="${data.file.name}" style="color: #64748b; text-decoration: none; display: flex; align-items: center;">
                    <span class="material-icons" style="font-size: 20px; cursor: pointer;">download</span>
                </a>
            </div>`;
    }

    // í…ìŠ¤íŠ¸ ë ˆì´ì•„ì›ƒ
    let textHtml = data.text ? `<div class="text-content" style="word-break: break-all; line-height: 1.5;">${data.text}</div>` : "";

    messageDiv.innerHTML = `
        <div class="bubble combined" style="max-width: 80%;">${fileHtml}${textHtml}</div>
        <div class="profile-group">
            <div class="avatar"></div>
            <input type="checkbox" id="check-${msgId}" class="custom-checkbox message-selector">
        </div>
    `;
    chatMessages.appendChild(messageDiv);
}

// 3. íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì²˜ë¦¬
function handleFilePreview(input) {
    const file = input.files[0];
    if (!file) return;
    selectedFile = file; // íŒŒì¼ ê°ì²´ ì €ì¥
    if (filePreviewContainer) {
        filePreviewContainer.innerHTML = `
            <div class="file-chip" style="display:inline-flex; align-items:center; background:#eff6ff; padding:5px 10px; border-radius:15px; font-size:13px;">
                <span>ğŸ“„ ${file.name}</span>
                <span class="remove-file" onclick="removeFilePreview()" style="cursor:pointer; margin-left:8px; font-weight:bold;">Ã—</span>
            </div>`;
    }
    input.value = '';
}

function removeFilePreview() {
    selectedFile = null;
    if (filePreviewContainer) filePreviewContainer.innerHTML = "";
}

// 4. íŒ¨ë„ ì œì–´ ë° ë¡œë”© (ë©”ì‹œì§€ ìˆ˜ì§‘ ë¡œì§)
function openPrompt() {
    const actionBtn = document.querySelector('.prompt-action-btn');
    if (!actionBtn) return;

    actionBtn.classList.add('loading');
    const originalContent = actionBtn.innerHTML;
    actionBtn.innerHTML = `<span class="spinner"></span> í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...`;

    setTimeout(() => {
        const selectedMessages = document.querySelectorAll('.message-selector:checked');
        let combinedText = "";

        selectedMessages.forEach((checkbox) => {
            const messageDiv = checkbox.closest('.message');

            const fileName = messageDiv.querySelector('.file-name');
            if (fileName) {
                combinedText += `[ì²¨ë¶€ íŒŒì¼: ${fileName.innerText.trim()}]\n`;
            }

            const textContent = messageDiv.querySelector('.text-content');
            if (textContent) {
                combinedText += textContent.innerText.trim() + "\n";
            }

            combinedText += "\n";
        });

        if (promptEditor) {
            promptEditor.innerText = combinedText.trim() || "ì„ íƒëœ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.";
        }
        if (promptAside) promptAside.classList.add('active');

        actionBtn.classList.remove('loading');
        actionBtn.innerHTML = originalContent;
    }, 1200);
}

function closePrompt() {
    if (promptAside) {
        promptAside.classList.remove('active');
        setTimeout(() => {
            if (!promptAside.classList.contains('active')) {
                promptAside.style.width = "";
            }
        }, 300);
    }
}

// 5. í´ë¦½ë³´ë“œ ë³µì‚¬ í•¨ìˆ˜
function copyPrompt() {
    const chatInput = document.getElementById('chat-input');
    const promptEditor = document.getElementById('prompt-editor-box');

    let textToCopy = "";

    if (chatInput && chatInput.value.trim() !== "") {
        textToCopy = chatInput.value.trim();
    } else if (promptEditor) {
        textToCopy = promptEditor.innerText.trim();
    }

    if (!textToCopy || textToCopy.includes("ì„ íƒëœ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤")) {
        alert("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const tempTextArea = document.createElement("textarea");
    tempTextArea.value = textToCopy;
    tempTextArea.style.position = "fixed";
    tempTextArea.style.left = "-9999px";
    tempTextArea.style.top = "0";
    document.body.appendChild(tempTextArea);
    tempTextArea.select();

    try {
        const successful = document.execCommand('copy');
        if (successful) {
            const copyBtn = document.querySelector('.btn-copy');
            if (copyBtn) {
                const originalHtml = copyBtn.innerHTML;
                copyBtn.innerHTML = `<span class="material-icons" style="font-size:16px;">done</span> ë³µì‚¬ ì™„ë£Œ!`;
                copyBtn.style.backgroundColor = "#bbf7d0";

                setTimeout(() => {
                    copyBtn.innerHTML = originalHtml;
                    copyBtn.style.backgroundColor = "";
                }, 2000);
            }
        }
    } catch (err) {
        console.error("ë³µì‚¬ ì˜¤ë¥˜:", err);
    } finally {
        document.body.removeChild(tempTextArea);
    }
}

// 6. ë“œë˜ê·¸ ë„ˆë¹„ ì¡°ì ˆ
const handle = document.getElementById('resize-handle');
let isResizing = false;
if (handle && promptAside) {
    handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        promptAside.style.transition = 'none';
        e.preventDefault();
    });
    window.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const newWidth = window.innerWidth - e.clientX;
        if (newWidth > 300 && newWidth < window.innerWidth * 0.8) {
            promptAside.style.width = `${newWidth}px`;
        }
    });
    window.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = 'default';
            document.body.style.userSelect = 'auto';
            promptAside.style.transition = 'width 0.3s ease, opacity 0.3s ease';
        }
    });
}

// 7. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
if (sendBtn) sendBtn.onclick = sendMessage;
if (chatInput) {
    chatInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    };
}
const copyBtnElement = document.querySelector('.btn-copy');
if (copyBtnElement) copyBtnElement.onclick = copyPrompt;